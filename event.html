<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Markdown Editor —Å –æ–≥–ª–∞–≤–ª–µ–Ω–∏–µ–º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- GitHub Markdown CSS –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–æ–±–µ —Ç–µ–º—ã) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.8.1/github-markdown-light.min.css" id="markdown-light">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.8.1/github-markdown-dark.min.css" id="markdown-dark" disabled>
  
  <style>
    /* CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f6f8fa;
      --bg-tertiary: #ffffff;
      --border-color: #d0d7de;
      --text-primary: #1f2328;
      --text-secondary: #656d76;
      --button-bg: #f6f8fa;
      --button-border: rgba(31, 35, 40, 0.15);
      --button-hover: #f3f4f6;
      --input-bg: #ffffff;
      --input-border: #d0d7de;
      --shadow-color: rgba(31, 35, 40, 0.12);
      --focus-color: #0969da;
      --success-bg: #1a7f37;
      --error-bg: #d1242f;
      --indicator-border: #0969da;
      --markdown-bg: #ffffff;
    }

    [data-theme="dark"] {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border-color: #30363d;
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --button-bg: #21262d;
      --button-border: rgba(240, 246, 252, 0.1);
      --button-hover: #30363d;
      --input-bg: #0d1117;
      --input-border: #30363d;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --focus-color: #58a6ff;
      --success-bg: #238636;
      --error-bg: #da3633;
      --indicator-border: #58a6ff;
      --markdown-bg: #0d1117;
    }

    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      margin: 0;
      padding: 0;
      color: var(--text-primary);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      max-width: 1012px;
      margin: 0 auto;
      padding: 20px;
    }

    /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 12px;
      background: var(--button-bg);
      border: 1px solid var(--button-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 20px;
      z-index: 1001;
      transition: background 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .theme-toggle:hover {
      background: var(--button-hover);
      transform: scale(1.05);
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–æ–π –ø–∞–Ω–µ–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
    .editor-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 20px;
      margin-top: 60px;
      overflow: hidden;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .editor-header {
      background: var(--bg-tertiary);
      padding: 12px 16px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      border-bottom: 1px solid var(--border-color);
      transition: background-color 0.3s ease;
    }

    .editor-header:hover {
      background: var(--button-hover);
    }

    .editor-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .toggle-icon {
      font-size: 12px;
      transition: transform 0.3s;
      color: var(--text-secondary);
    }

    .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }

    .editor-content {
      padding: 16px;
      display: none;
    }

    .editor-content.expanded {
      display: block;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    input[type="text"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 8px 12px;
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 14px;
      color: var(--text-primary);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    textarea:focus,
    select:focus {
      outline: none;
      border-color: var(--focus-color);
      box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.3);
    }

    [data-theme="dark"] input[type="text"]:focus,
    [data-theme="dark"] input[type="password"]:focus,
    [data-theme="dark"] textarea:focus,
    [data-theme="dark"] select:focus {
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 13px;
      line-height: 1.5;
    }

    .buttons {
      margin-top: 15px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      padding: 5px 16px;
      border: 1px solid var(--button-border);
      border-radius: 6px;
      background: var(--button-bg);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s, border-color 0.2s;
    }

    button:hover {
      background: var(--button-hover);
      border-color: var(--text-secondary);
    }

    button:active {
      background: var(--button-hover);
      transform: scale(0.98);
    }

    #domain-controls {
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    #domain-controls label {
      margin: 0;
      font-weight: normal;
    }

    #domain-controls select {
      width: auto;
      flex: 1;
      min-width: 200px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ —Å—Ç–∏–ª–µ GitHub */
    .preview-container {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 0;
      margin-top: 20px;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .preview-header {
      background: var(--bg-secondary);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-color);
      border-radius: 6px 6px 0 0;
    }

    .preview-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* GitHub markdown body —Å—Ç–∏–ª–∏ */
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0;
      padding: 45px;
      background: var(--markdown-bg);
      transition: background-color 0.3s ease;
    }

    @media (max-width: 767px) {
      .markdown-body {
        padding: 15px;
      }
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —è–∫–æ—Ä—è–º */
    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3,
    .markdown-body h4,
    .markdown-body h5,
    .markdown-body h6 {
      scroll-margin-top: 20px;
    }

    /* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    html {
      scroll-behavior: smooth;
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification {
      position: fixed;
      top: 20px;
      right: 80px;
      padding: 12px 20px;
      background: var(--success-bg);
      color: white;
      border-radius: 6px;
      box-shadow: 0 8px 24px var(--shadow-color);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease-out;
    }

    .notification.error {
      background: var(--error-bg);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
    .view-mode-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      z-index: 999;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }

    .view-mode-indicator.readonly {
      border-color: var(--indicator-border);
      color: var(--indicator-border);
    }

    .section-divider {
      margin: 20px 0;
      padding-top: 15px;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <div class="notification" id="notification"></div>
  <div class="view-mode-indicator" id="viewModeIndicator">–†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
  <button class="theme-toggle" id="themeToggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
      <span id="themeIcon">üåô</span>
  </button>

  <div class="container">
    <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="editor-panel">
      <div class="editor-header" id="editorHeader">
        <h2>üîí –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      
      <div class="editor-content" id="editorContent">
        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è -->
        <div id="passwordSection">
          <label for="password-input">–ü–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</label>
          <input type="password" id="password-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          <div class="buttons">
            <button id="unlock-btn">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
          </div>
          <p style="font-size: 12px; color: #8b949e; margin-top: 10px;">
            üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ë–µ–∑ –ø–∞—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
          </p>
        </div>
        
        <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="editingSection" style="display: none;">
          <!-- –ü–∞–Ω–µ–ª—å –¥–ª—è –∑–∞–º–µ–Ω—ã –¥–æ–º–µ–Ω–∞ –≤ —Å—Å—ã–ª–∫–∞—Ö -->
          <div id="domain-controls">
            <label for="domain-select">–ó–∞–º–µ–Ω–∏—Ç—å –¥–æ–º–µ–Ω:</label>
            <select id="domain-select">
              <option value="www.heroeswm.ru">www.heroeswm.ru</option>
              <option value="my.lordswm.com">my.lordswm.com</option>
              <option value="lordswm.com">lordswm.com</option>
              <option value="www.lordswm.com">www.lordswm.com</option>
              <option value="mirror.heroeswm.ru">mirror.heroeswm.ru</option>
            </select>
            <button id="replace-domain">–ó–∞–º–µ–Ω–∏—Ç—å</button>
          </div>
          
          <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∏—Å—Ö–æ–¥–Ω–æ–≥–æ markdown -->
          <label for="markdown-source">–ò—Å—Ö–æ–¥–Ω—ã–π markdown:</label>
          <textarea id="markdown-source" placeholder="–í–≤–µ–¥–∏—Ç–µ markdown –∑–¥–µ—Å—å..."></textarea>
          
          <div class="buttons">
            <button id="update-btn">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
            <button id="download-btn">–°–∫–∞—á–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫</button>
            <button id="copy-btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–∏–∫</button>
            <button id="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          </div>
          
          <!-- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ -->
          <div class="section-divider">
            <h3 style="margin-top: 0; font-size: 14px;">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å</h3>
            <label for="entry-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (h3):</label>
            <input type="text" id="entry-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫">
            <label for="entry-content">–¢–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏:</label>
            <textarea id="entry-content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø–∏—Å–∏"></textarea>
            <div class="buttons">
              <button id="add-entry-btn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω–Ω–æ–≥–æ markdown -->
    <div class="preview-container">
      <div class="preview-header">
        <h2>üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞</h2>
      </div>
      <article class="markdown-body" id="markdown-preview"></article>
    </div>
  </div>
  
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ marked.js –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    /********** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è **********/
    const CORRECT_PASSWORD = "AnyKeyRoadToTop3";
    const storageKey = "markdownDocument";
    let docText = "";
    let isUnlocked = false;
    
    const themeStorageKey = "themePreference";
    let currentTheme = "light"; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞

    /********** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π **********/
    function setTheme(theme) {
      currentTheme = theme;
      const html = document.documentElement;
      const themeIcon = document.getElementById("themeIcon");
      const markdownLight = document.getElementById("markdown-light");
      const markdownDark = document.getElementById("markdown-dark");
      
      if (theme === "dark") {
        html.setAttribute("data-theme", "dark");
        themeIcon.textContent = "‚òÄÔ∏è";
        markdownLight.disabled = true;
        markdownDark.disabled = false;
      } else {
        html.setAttribute("data-theme", "light");
        themeIcon.textContent = "üåô";
        markdownLight.disabled = false;
        markdownDark.disabled = true;
      }
      
      localStorage.setItem(themeStorageKey, theme);
    }

    function toggleTheme() {
      const newTheme = currentTheme === "light" ? "dark" : "light";
      setTheme(newTheme);
      showNotification(`–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${newTheme === "dark" ? "—Ç—ë–º–Ω—É—é" : "—Å–≤–µ—Ç–ª—É—é"}`);
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem(themeStorageKey);
      // –ï—Å–ª–∏ —Ç–µ–º—ã –Ω–µ—Ç –≤ localStorage, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–µ—Ç–ª—É—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setTheme(savedTheme || "light");
    }

    
    /********** –ù–∞—Å—Ç—Ä–æ–π–∫–∞ marked –¥–ª—è GitHub-—Å—Ç–∏–ª—è **********/
    marked.setOptions({
      gfm: true,
      breaks: true,
      headerIds: true,
      mangle: false
    });
    
    /********** –§—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π **********/
    function showNotification(message, isError = false) {
      const notification = document.getElementById("notification");
      notification.textContent = message;
      notification.className = "notification" + (isError ? " error" : "");
      notification.style.display = "block";
      setTimeout(() => {
        notification.style.display = "none";
      }, 3000);
    }
    
    /********** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞–º–∏ **********/
    function updateViewMode() {
      const indicator = document.getElementById("viewModeIndicator");
      if (isUnlocked) {
        indicator.textContent = "üîì –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è";
        indicator.classList.remove("readonly");
      } else {
        indicator.textContent = "üëÅÔ∏è –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞";
        indicator.classList.add("readonly");
      }
    }
    
    /********** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è **********/
    function checkPassword() {
      const passwordInput = document.getElementById("password-input");
      const enteredPassword = passwordInput.value;
      
      if (enteredPassword === CORRECT_PASSWORD) {
        isUnlocked = true;
        document.getElementById("passwordSection").style.display = "none";
        document.getElementById("editingSection").style.display = "block";
        showNotification("‚úÖ –î–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω! –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ.");
        updateViewMode();
        passwordInput.value = "";
      } else {
        showNotification("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!", true);
        passwordInput.value = "";
      }
    }
    
    /********** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è **********/
    function toggleEditorPanel() {
      const content = document.getElementById("editorContent");
      const icon = document.querySelector(".toggle-icon");
      
      if (content.classList.contains("expanded")) {
        content.classList.remove("expanded");
        icon.classList.add("collapsed");
      } else {
        content.classList.add("expanded");
        icon.classList.remove("collapsed");
      }
    }
    
    /********** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è slug –¥–ª—è —è–∫–æ—Ä–µ–π **********/
    function generateSlug(text) {
      return text
        .toLowerCase()
        .trim()
        .replace(/\s+/g, "-")
        .replace(/[^\p{L}\p{N}-]+/gu, "");
    }
    
    /********** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ localStorage **********/
    function loadMarkdown() {
      const stored = localStorage.getItem(storageKey);
      docText = stored ? stored : "";
      document.getElementById("markdown-source").value = docText;
      updatePreview();
    }
    
    function saveMarkdown() {
      localStorage.setItem(storageKey, docText);
    }
    
    /********** –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ **********/
    function updatePreview() {
      if (isUnlocked) {
        docText = document.getElementById("markdown-source").value;
        saveMarkdown();
      }
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º marked –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ID –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
      const renderer = {
        heading({ tokens, depth }) {
          // –ü–∞—Ä—Å–∏–º —Ç–æ–∫–µ–Ω—ã –≤ —Ç–µ–∫—Å—Ç
          const text = this.parser.parseInline(tokens);
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º slug –∏–∑ —Ç–µ–∫—Å—Ç–∞
          const slug = generateSlug(text);
          return `<h${depth} id="${slug}">${text}</h${depth}>\n`;
        }
      };
      
      marked.use({ 
        renderer: renderer,
        gfm: true,
        breaks: true,
        headerIds: true,
        mangle: false
      });
      
      document.getElementById("markdown-preview").innerHTML = marked.parse(docText);
    }
    
    /********** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ **********/
    function addEntry() {
      if (!isUnlocked) {
        showNotification("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!", true);
        return;
      }
      
      const titleInput = document.getElementById("entry-title");
      const contentInput = document.getElementById("entry-content");
      const title = titleInput.value.trim();
      let content = contentInput.value.trim();
      
      if (!title) {
        showNotification("‚ùå –í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫!", true);
        return;
      }
      
      const now = new Date();
      const dateStr = now.toLocaleDateString("ru-RU", { day: "numeric", month: "long" });
      const dateSlug = generateSlug(dateStr);
      const slug = generateSlug(title);
      
      let entryMarkdown = `---\n### ${title}\n\n[–ù–∞–≤–µ—Ä—Ö](#${dateSlug})\n\n${content}\n\n`;
      
      const tocHeader = `## ${dateStr}`;
      const tocLinkPrefix = "- [";
      
      if (docText.includes(tocHeader)) {
        const lines = docText.split("\n");
        let newDocLines = [];
        let inToc = false;
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].trim() === tocHeader) {
            inToc = true;
            newDocLines.push(lines[i]);
            newDocLines.push(`${tocLinkPrefix}${title}](#${slug})`);
            continue;
          }
          if (inToc && lines[i].startsWith("## ")) {
            inToc = false;
          }
          newDocLines.push(lines[i]);
        }
        docText = newDocLines.join("\n");
        let docLines = docText.trim().split("\n");
        if (docLines[docLines.length - 1].trim() === "---") {
          entryMarkdown = entryMarkdown.replace(/^---\n/, "");
        }
        docText += "\n" + entryMarkdown;
      } else {
        const newTOC = `${tocHeader}\n${tocLinkPrefix}${title}](#${slug})\n\n---\n\n`;
        docText = newTOC + docText;
        let docLines = docText.trim().split("\n");
        if (docLines[docLines.length - 1].trim() === "---") {
          entryMarkdown = entryMarkdown.replace(/^---\n/, "");
        }
        docText += "\n" + entryMarkdown;
      }
      
      // –ü–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–π –ø–æ –¥–∞—Ç–∞–º
      let lines = docText.split("\n");
      let tocSections = {};
      let contentLines = [];
      let currentToc = null;
      
      for (let line of lines) {
        if (line.startsWith("## ")) {
          currentToc = line;
          tocSections[currentToc] = [];
        } else if (currentToc && line.startsWith("- [")) {
          tocSections[currentToc].push(line);
        } else {
          contentLines.push(line);
        }
      }
      
      let tocKeys = Object.keys(tocSections);
      tocKeys.sort((a, b) => {
        const dateA = a.substring(3).trim();
        const dateB = b.substring(3).trim();
        function parseDate(dateStr) {
          const parts = dateStr.split(" ");
          let day = parseInt(parts[0]);
          let monthName = parts[1];
          const months = {
            "—è–Ω–≤–∞—Ä—è": 0, "—Ñ–µ–≤—Ä–∞–ª—è": 1, "–º–∞—Ä—Ç–∞": 2, "–∞–ø—Ä–µ–ª—è": 3,
            "–º–∞—è": 4, "–∏—é–Ω—è": 5, "–∏—é–ª—è": 6, "–∞–≤–≥—É—Å—Ç–∞": 7,
            "—Å–µ–Ω—Ç—è–±—Ä—è": 8, "–æ–∫—Ç—è–±—Ä—è": 9, "–Ω–æ—è–±—Ä—è": 10, "–¥–µ–∫–∞–±—Ä—è": 11
          };
          let month = months[monthName];
          let year = new Date().getFullYear();
          if (new Date().getMonth() === 11 && month === 0) {
            year++;
          }
          return new Date(year, month, day);
        }
        return parseDate(dateB) - parseDate(dateA);
      });
      
      let newTOCBlock = "";
      for (let key of tocKeys) {
        newTOCBlock += key + "\n";
        tocSections[key].forEach(bullet => newTOCBlock += bullet + "\n");
        newTOCBlock += "\n";
      }
      
      docText = newTOCBlock + "\n" + contentLines.join("\n");
      
      document.getElementById("markdown-source").value = docText;
      updatePreview();
      titleInput.value = "";
      contentInput.value = "";
      showNotification("‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
    }
    
    /********** –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ **********/
    function downloadSource() {
      const blob = new Blob([docText], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "document.md";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showNotification("üì• –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω!");
    }
    
    /********** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ **********/
    function copySource() {
      navigator.clipboard.writeText(docText)
        .then(() => { showNotification("üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!"); })
        .catch(err => { showNotification("‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: " + err, true); });
    }
    
    /********** –û—á–∏—Å—Ç–∫–∞ localStorage **********/
    function clearData() {
      if (!isUnlocked) {
        showNotification("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö!", true);
        return;
      }
      
      if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) {
        localStorage.removeItem(storageKey);
        docText = "";
        document.getElementById("markdown-source").value = "";
        updatePreview();
        showNotification("üóëÔ∏è –î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!");
      }
    }
    
    /********** –ó–∞–º–µ–Ω–∞ –¥–æ–º–µ–Ω–∞ –≤ —Å—Å—ã–ª–∫–∞—Ö **********/
    function replaceDomains() {
      if (!isUnlocked) {
        showNotification("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!", true);
        return;
      }
      
      const selectedDomain = document.getElementById("domain-select").value;
      const domains = ["www.heroeswm.ru", "my.lordswm.com", "lordswm.com", "www.lordswm.com", "mirror.heroeswm.ru"];
      const regex = new RegExp("(" + domains.join("|").replace(/\./g, "\\.") + ")", "gi");
      docText = docText.replace(regex, selectedDomain);
      document.getElementById("markdown-source").value = docText;
      updatePreview();
      showNotification("üîÑ –î–æ–º–µ–Ω—ã –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ " + selectedDomain);
    }
    
    /********** –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π **********/
    document.getElementById("themeToggle").addEventListener("click", toggleTheme);
    document.getElementById("unlock-btn").addEventListener("click", checkPassword);
    document.getElementById("password-input").addEventListener("keypress", (e) => {
      if (e.key === "Enter") checkPassword();
    });
    document.getElementById("editorHeader").addEventListener("click", toggleEditorPanel);
    document.getElementById("add-entry-btn").addEventListener("click", addEntry);
    document.getElementById("download-btn").addEventListener("click", downloadSource);
    document.getElementById("copy-btn").addEventListener("click", copySource);
    document.getElementById("clear-btn").addEventListener("click", clearData);
    document.getElementById("update-btn").addEventListener("click", updatePreview);
    document.getElementById("replace-domain").addEventListener("click", replaceDomains);
    
    document.getElementById("markdown-source").addEventListener("input", () => {
      if (isUnlocked) {
        docText = document.getElementById("markdown-source").value;
        saveMarkdown();
        updatePreview();
      }
    });
    
    /********** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ **********/
    window.onload = function() {
      loadTheme(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
      loadMarkdown();
      updateViewMode();
      // –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–µ—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      document.querySelector(".toggle-icon").classList.add("collapsed");
    };
  </script>
</body>
</html>
