<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Парсер боёв</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 20px;
            text-align: center;
        }
        textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }
        .options {
            text-align: left;
            margin-bottom: 10px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .half {
            flex: 1;
        }
    </style>
</head>
<body>
    <h2>Парсер боёв v16</h2>
    <button id="toggleInputButton" onclick="toggleInput()">Свернуть</button>
    <div id="inputContainer">
        <div class="container">
            <div class="half">
                <h3>Входные данные (HTML)</h3>
                <textarea id="battleInput" placeholder="Вставьте HTML страницы с боями...
Можно вставить сразу несколько страниц.
Проще всего: откройте протокол боёв, нажмите CTRL+U, затем CTRL+A, CTRL+C и вставьте сюда (CTRL+V)."></textarea>
            </div>
            <div class="half">
                <h3>Фильтр боёв</h3>
                <textarea id="filterInput">Праздничные злодеи
Стражи серебра
Враждебный отряд
Лесные грабители
Пираты
Враги племени Ярости
Вражеский караван
Вражеские стражи
Хранители артефактов
Враги портала
Цель</textarea>
            </div>
        </div>
        
        <div class="options">
            <label><input type="checkbox" id="doFilter" checked> Выбрать бои с ивента</label><br>
            <label><input type="checkbox" id="onlyWins"> Показывать только победы</label><br>
            <label><input type="checkbox" id="watchFromStart" checked> Указывать на начало боя</label><br>
            <label><input type="checkbox" id="removeDate"> Удалить дату и время после сортировки</label><br>
            <label><input type="checkbox" id="removeMostCommon"> Удалить никнейм</label><br>
            <label><input type="checkbox" id="useLordswm"> Использовать my.lordswm.com вместо www.heroeswm.ru</label><br>
        </div>
    </div>
    
    <button onclick="processBattles()">Обработать</button>
    
    <h3 id="resultTitle">Результат:</h3>
    <pre id="result"></pre>
    <button id="copyButton" onclick="copyResult()">Скопировать результат</button>
    
    <script>
        function toggleInput() {
            let inputContainer = document.getElementById("inputContainer");
            let toggleButton = document.getElementById("toggleInputButton");
            
            if (inputContainer.style.display === "none") {
                inputContainer.style.display = "block";
                toggleButton.textContent = "Свернуть";
            } else {
                inputContainer.style.display = "none";
                toggleButton.textContent = "Развернуть";
            }
        }

        function copyResult() {
            let resultText = document.getElementById("result").textContent.trim();
            let mostCommonName = document.getElementById("resultTitle").textContent.trim();
            let removeMostCommon = document.getElementById('removeMostCommon').checked;
    
            if (!resultText) {
                alert("Результат пуст, нечего копировать!");
                return;
            }
    
            let textToCopy = removeMostCommon ? `${mostCommonName}\n${resultText}` : resultText;
    
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert("Результат скопирован в буфер обмена!");
            }).catch(err => {
                console.error("Ошибка при копировании: ", err);
                alert("Ошибка при копировании!");
            });
        }

        function extractBattles(html, filters, doFilter, onlyWins, watchFromStart, useLordswm) {
            let matches = [...html.matchAll(/href="warlog\\.php\\?warid=(\\d+)".*?>(\\d{2}-\\d{2}-\\d{2} \\d{2}:\\d{2})<\/a>:.*?<b><a.*?>(.*?)<\/a>.*?vs.*?<i>(.*?)<\/i>/g)];
            let battles = matches.map(match => {
                let warId = match[1];
                let dateTime = match[2];
                let left = match[3].trim();
                let right = match[4].trim();
                let baseDomain = useLordswm ? "my.lordswm.com" : "www.heroeswm.ru";
                let battleLink = `https://${baseDomain}/warlog.php?warid=${warId}`;
                return `${dateTime} ${left} vs ${right} ${battleLink}`;
            });
            return battles.join('\n');
        }

        function processBattles() {
            let html = document.getElementById("battleInput").value;
            let filters = document.getElementById("filterInput").value.split('\n').map(f => f.trim()).filter(f => f);
            let doFilter = document.getElementById("doFilter").checked;
            let onlyWins = document.getElementById("onlyWins").checked;
            let watchFromStart = document.getElementById("watchFromStart").checked;
            let useLordswm = document.getElementById("useLordswm").checked;
    
            let result = extractBattles(html, filters, doFilter, onlyWins, watchFromStart, useLordswm);
            document.getElementById("result").textContent = result || "Ничего не найдено";
    
            document.getElementById("inputContainer").style.display = "none";
            document.getElementById("toggleInputButton").textContent = "Развернуть";
        }
    </script>
</body>
</html>
